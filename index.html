// UUIDs
const characteristicUUID = "2A63"; // Cycling Power Measurement
const serviceUUID = "00001818-0000-1000-8000-00805f9b34fb";

// Variables
let totalWatts = 0;
let dataCount = 0;
let timerInterval;
let elapsedSeconds = 0;

// Helper Functions
function formatTime(seconds) {
    const hours = String(Math.floor(seconds / 3600)).padStart(2, '0');
    const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
    const secs = String(seconds % 60).padStart(2, '0');
    return `${hours}:${minutes}:${secs}`;
}

function updateDisplay(power, cadence) {
    const powerElement = document.getElementById('power');
    const cadenceElement = document.getElementById('cadence');
    const totalWattsElement = document.getElementById('totalWatts');

    powerElement.innerText = `Power: ${power} W`;
    cadenceElement.innerText = `Cadence: ${cadence} RPM`;

    totalWatts += power;
    dataCount++;
    totalWattsElement.innerText = `Total Watts: ${totalWatts}`;
}

function startTimer() {
    timerInterval = setInterval(() => {
        elapsedSeconds++;
        document.getElementById('timer').innerText = formatTime(elapsedSeconds);
    }, 1000);
}

function stopTimer() {
    clearInterval(timerInterval);
}

function resetTimer() {
    clearInterval(timerInterval);
    elapsedSeconds = 0;
    document.getElementById('timer').innerText = formatTime(elapsedSeconds);
}

// Bluetooth Connection
navigator.bluetooth.requestDevice({
    acceptAllDevices: true,
    optionalServices: [serviceUUID]
}).then(device => device.gatt.connect())
  .then(server => server.getPrimaryService(serviceUUID))
  .then(service => service.getCharacteristic(characteristicUUID))
  .then(characteristic => {
      characteristic.startNotifications();

      characteristic.addEventListener('characteristicvaluechanged', event => {
          const data = event.target.value;
          const power = data.getUint16(0, true); // Extract power in watts
          const cadence = data.getUint16(2, true); // Extract cadence in RPM

          updateDisplay(power, cadence);
      });

      startTimer();
  }).catch(console.error);

// HTML Setup (Add this to your HTML body):
// <div id="display" style="text-align:center; font-family: Arial, sans-serif;">
//   <div id="power" style="font-size: 48px; margin: 20px;">Power: -- W</div>
//   <div id="cadence" style="font-size: 48px; margin: 20px;">Cadence: -- RPM</div>
//   <div id="totalWatts" style="font-size: 48px; margin: 20px;">Total Watts: --</div>
//   <div id="timer" style="font-size: 48px; margin: 20px;">00:00:00</div>
//   <button onclick="startTimer()" style="font-size: 24px; margin: 10px;">Start Timer</button>
//   <button onclick="stopTimer()" style="font-size: 24px; margin: 10px;">Stop Timer</button>
//   <button onclick="resetTimer()" style="font-size: 24px; margin: 10px;">Reset Timer</button>
// </div>
